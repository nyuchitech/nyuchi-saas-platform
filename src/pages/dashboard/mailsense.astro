---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
---

<Layout title="MailSense Dashboard - Nyuchi Platform">
  <Header />
  
  <main class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Dashboard Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 mb-2">MailSense Dashboard</h1>
          <p class="text-gray-600">Manage your AI-powered email organization</p>
        </div>
        <div class="flex space-x-3">
          <a href="/dashboard" class="btn btn-secondary">← Back to Dashboard</a>
          <button class="btn btn-primary" onclick="syncEmails()">Sync Emails</button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Total Emails</p>
              <p class="text-2xl font-bold text-gray-900" id="total-emails">1,247</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Processed Today</p>
              <p class="text-2xl font-bold text-gray-900" id="processed-today">89</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Categories</p>
              <p class="text-2xl font-bold text-gray-900" id="categories-count">8</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-600">Time Saved</p>
              <p class="text-2xl font-bold text-gray-900" id="time-saved">4.2h</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Connected Accounts & Recent Emails -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Connected Accounts -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-bold text-gray-900">Connected Email Accounts</h3>
              <button class="btn btn-primary text-sm" onclick="addAccount()">+ Add Account</button>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-4" id="email-accounts">
              <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center">
                  <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-red-600 font-bold text-sm">G</span>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">john@company.com</p>
                    <p class="text-sm text-gray-500">Gmail • Last sync: 2 min ago</p>
                  </div>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Active
                </span>
              </div>
              
              <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                <div class="flex items-center">
                  <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                    <span class="text-blue-600 font-bold text-sm">O</span>
                  </div>
                  <div>
                    <p class="font-medium text-gray-900">john.doe@outlook.com</p>
                    <p class="text-sm text-gray-500">Outlook • Last sync: 1 hour ago</p>
                  </div>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  Syncing
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Emails -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-900">Recent Emails</h3>
          </div>
          <div class="p-6">
            <div class="space-y-4" id="recent-emails">
              <div class="border-l-4 border-blue-500 pl-4">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-medium text-gray-900 text-sm">Weekly Team Update</p>
                  <span class="text-xs text-gray-500">2 min ago</span>
                </div>
                <p class="text-sm text-gray-600">from: manager@company.com</p>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                  Work
                </span>
              </div>

              <div class="border-l-4 border-green-500 pl-4">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-medium text-gray-900 text-sm">Dinner Plans Tonight?</p>
                  <span class="text-xs text-gray-500">15 min ago</span>
                </div>
                <p class="text-sm text-gray-600">from: sarah@gmail.com</p>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                  Personal
                </span>
              </div>

              <div class="border-l-4 border-purple-500 pl-4">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-medium text-gray-900 text-sm">Weekly Newsletter</p>
                  <span class="text-xs text-gray-500">1 hour ago</span>
                </div>
                <p class="text-sm text-gray-600">from: newsletter@techcrunch.com</p>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800">
                  Newsletter
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Categories -->
      <div class="bg-white rounded-lg shadow mb-8">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Email Categories</h3>
            <button class="btn btn-primary text-sm" onclick="createCategory()">+ New Category</button>
          </div>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="email-categories">
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-blue-500 rounded-full mr-2"></div>
                  <span class="font-medium text-gray-900">Work</span>
                </div>
                <span class="text-sm text-gray-500">423</span>
              </div>
              <p class="text-xs text-gray-600">Business emails and meetings</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-green-500 rounded-full mr-2"></div>
                  <span class="font-medium text-gray-900">Personal</span>
                </div>
                <span class="text-sm text-gray-500">187</span>
              </div>
              <p class="text-xs text-gray-600">Friends and family emails</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-purple-500 rounded-full mr-2"></div>
                  <span class="font-medium text-gray-900">Newsletters</span>
                </div>
                <span class="text-sm text-gray-500">312</span>
              </div>
              <p class="text-xs text-gray-600">Subscriptions and updates</p>
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <div class="w-4 h-4 bg-orange-500 rounded-full mr-2"></div>
                  <span class="font-medium text-gray-900">Finance</span>
                </div>
                <span class="text-sm text-gray-500">89</span>
              </div>
              <p class="text-xs text-gray-600">Banking and receipts</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <h3 class="text-lg font-bold text-gray-900">MailSense Settings</h3>
        </div>
        <div class="p-6">
          <div class="space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-medium text-gray-900">Auto-categorization</h4>
                <p class="text-sm text-gray-600">Automatically categorize incoming emails</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-medium text-gray-900">AI Summaries</h4>
                <p class="text-sm text-gray-600">Generate AI summaries for long emails</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>

            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-medium text-gray-900">Smart Filters</h4>
                <p class="text-sm text-gray-600">Apply intelligent email filters</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>

            <div class="border-t border-gray-200 pt-6">
              <button class="btn btn-primary">Save Settings</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Dashboard functions
    async function syncEmails() {
      try {
  const response = await fetch('/api/mailsense/sync-account', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            organization_id: 'user-org-id',
            user_id: 'user-id',
            email: 'john@company.com',
            provider: 'gmail'
          })
        });
        
        if (response.ok) {
          alert('Emails synced successfully!');
          location.reload();
        } else {
          alert('Error syncing emails. Please try again.');
        }
      } catch (error) {
        alert('Error syncing emails. Please try again.');
      }
    }

    async function addAccount() {
      // Redirect to OAuth flow or show modal
      alert('Add account feature coming soon!');
    }

    async function createCategory() {
      const name = prompt('Enter category name:');
      if (name) {
        try {
          const response = await fetch('/api/mailsense/create-category', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              organization_id: 'user-org-id',
              name: name,
              color: '#3b82f6'
            })
          });
          
          if (response.ok) {
            alert('Category created successfully!');
            location.reload();
          } else {
            alert('Error creating category. Please try again.');
          }
        } catch (error) {
          alert('Error creating category. Please try again.');
        }
      }
    }

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Load recent emails
  const emailsResponse = await fetch('/api/mailsense/get-messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            account_id: 1,
            limit: 10
          })
        });
        
        // Handle response (customer-friendly error messages only)
        if (!emailsResponse.ok) {
          console.warn('Could not load recent emails');
        }
      } catch (error) {
        console.warn('Dashboard data loading error');
      }
    });
  </script>
</Layout>
